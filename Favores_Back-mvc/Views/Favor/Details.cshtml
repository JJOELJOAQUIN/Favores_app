@model Favores_Back_mvc.Models.Favor
@using System.Linq

@{
    ViewData["Title"] = "Detalle del Favor";

    var usuarioId = Context.Session.GetInt32("UsuarioId");
    var usuarioRol = Context.Session.GetString("UsuarioRol");

    var postulaciones = Model.Postulaciones ?? Enumerable.Empty<Favores_Back_mvc.Models.Postulacion>();
    bool esCreador = usuarioId == Model.CreadorId;
    bool yaSePostulo = usuarioId != null && postulaciones.Any(p => p.UsuarioId == usuarioId);
}

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    .favor-header-img {
        width: 100%;
        height: 260px;
        object-fit: cover;
        border-radius: 18px;
    }

    .postul-card:hover {
        background: #f8f9fa;
    }
</style>

<div class="container mt-4">

    <!-- ============================
         IMAGEN PRINCIPAL
    ============================= -->
    <img src="/img/categorias/@(Model.Categoria?.ToLower() ?? "default").jpg"
         onerror="this.src='/img/favores/default-favor.jpg'"
         class="favor-header-img shadow-sm" />

    <!-- ============================
         TÍTULO + CATEGORÍA
    ============================= -->
    <div class="mt-4">
        <h2 class="fw-bold">@Model.Titulo</h2>

        <span class="badge bg-info text-dark">
            <i class="bi bi-tag"></i> @Model.Categoria
        </span>

        <p class="text-muted mt-2">
            <i class="bi bi-geo-alt"></i> @Model.Ubicacion
        </p>
    </div>

    <!-- ============================
         RECOMPENSA
    ============================= -->
    <div class="mt-3 p-3 bg-light rounded shadow-sm">
        <h5 class="mb-1 fw-semibold">
            <i class="bi bi-cash-coin"></i> Recompensa
        </h5>
        <p class="fs-4 text-primary fw-bold mb-0">
            @Model.Recompensa @Model.TipoRecompensa
        </p>
    </div>

    <!-- ============================
         DESCRIPCIÓN
    ============================= -->
    <div class="mt-4">
        <h5 class="fw-semibold">Descripción</h5>
        <p class="text-muted fs-5">@Model.Descripcion</p>
    </div>

    <!-- ============================
         INFO DEL CREADOR
    ============================= -->
    <div class="mt-4 p-3 rounded border bg-white shadow-sm d-flex align-items-center">

        <img src="@(Model.Creador?.FotoPerfil ?? "/img/default-user.png")"
             class="rounded-circle me-3 border"
             style="width:70px; height:70px; object-fit:cover;" />

        <div>
            <h5 class="fw-bold">@Model.Creador?.Nombre</h5>
            <p class="text-muted mb-0">
                <i class="bi bi-envelope"></i>
                @Model.Creador?.Email
            </p>
            <p class="text-warning fw-bold mb-0">
                ⭐ @Model.Creador?.Reputacion
            </p>
        </div>

    </div>

    <!-- ============================
         POSTULARSE (botón dinámico)
    ============================= -->
    <div class="mt-4">

        @if (usuarioId == null)
        {
            <div class="alert alert-warning">
                Debes iniciar sesión para postularte.
            </div>
        }
        else if (esCreador)
        {
            <div class="alert alert-info">
                Eres el creador del favor y no puedes postularte.
            </div>
        }
        else if (yaSePostulo)
        {
            <div class="alert alert-success">
                Ya te postulaste a este favor.
            </div>
        }
        else
        {
            <form asp-controller="Postulacion" asp-action="Postularse" method="post">
                <input type="hidden" name="favorId" value="@Model.Id" />
                <button class="btn btn-primary btn-lg w-100">
                    <i class="bi bi-hand-thumbs-up"></i> Postularme
                </button>
            </form>
        }
    </div>

    <!-- ============================
         POSTULACIONES
    ============================= -->
    <div class="mt-5">

        <h4 class="fw-bold mb-3">Postulaciones (@postulaciones.Count())</h4>

        @if (!postulaciones.Any())
        {
            <p class="text-muted">No hay postulaciones aún.</p>
        }
        else
        {
            <ul class="list-group">

                @foreach (var p in postulaciones)
                {
                    <li class="list-group-item postul-card d-flex justify-content-between align-items-center">

                        <div>
                            <strong>@(p.Usuario?.Nombre ?? "Usuario desconocido")</strong><br />
                            <span class="text-muted">@p.Usuario?.Email</span><br />
                            <span>@p.Mensaje</span>
                        </div>

                        @if (esCreador && p.Estado == "Pendiente")
                        {
                            <form asp-controller="Postulacion" asp-action="Aceptar" method="post">
                                <input type="hidden" name="id" value="@p.Id" />
                                <button class="btn btn-success btn-sm">
                                    <i class="bi bi-check-lg"></i> Aceptar
                                </button>
                            </form>
                        }
                        else
                        {
                            <span class="badge bg-secondary">@p.Estado</span>
                        }

                    </li>
                }

            </ul>
        }
    </div>

    <!-- ============================
         BOTÓN AL CHAT
    ============================= -->
    @if (Model.Chat != null)
    {
        <a asp-controller="Chat" asp-action="Details" asp-route-id="@Model.Chat.Id"
           class="btn btn-outline-primary btn-lg w-100 mt-4">
            <i class="bi bi-chat-dots"></i> Abrir Chat
        </a>
    }

</div>
