@model Favores_Back_mvc.Models.Favor
@using Favores_Back_mvc.Models
@using System.Linq

<hr />

<h3>DEBUG:</h3>

<p>UsuarioId sesión: @Context.Session.GetInt32("UsuarioId")</p>
<p>CreadorId del Favor: @Model.CreadorId</p>
<p>Total Postulaciones: @Model.Postulaciones.Count</p>

@if (TempData["Ok"] != null)
{
    <div class="alert alert-success">@TempData["Ok"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

@{
    var usuarioId = Context.Session.GetInt32("UsuarioId");
    bool esCreador = usuarioId.HasValue && usuarioId.Value == Model.CreadorId;

    var postulaciones = (Model.Postulaciones as IEnumerable<Postulacion>)
                        ?? Enumerable.Empty<Postulacion>();

    bool yaSePostulo = usuarioId.HasValue
        && postulaciones.Any(p => p.UsuarioId == usuarioId.Value);
}


@if (usuarioId == null)
{
    <div class="alert alert-warning">Debes iniciar sesión para postularte.</div>
}
else if (esCreador)
{
    <div class="alert alert-info">Eres el creador del favor. No puedes postularte.</div>
}
else if (yaSePostulo)
{
    <div class="alert alert-success">Ya te postulaste a este favor.</div>
}
else
{
    <form asp-controller="Postulacion" asp-action="Postularse" method="post">
        <input type="hidden" name="favorId" value="@Model.Id" />
        <button type="submit" class="btn btn-primary mt-3">Postularse</button>
    </form>
}

<hr />

<h4 class="mt-4">Postulaciones</h4>

@if (Model.Postulaciones == null || !Model.Postulaciones.Any())
{
    <p class="text-muted">No hay postulaciones aún.</p>
}
else
{
    <ul class="list-group">
        @foreach (var p in Model.Postulaciones)
        {
            <li class="list-group-item d-flex justify-content-between">
                <span>
                    <strong>@(p.Usuario?.Email ?? "Usuario desconocido")</strong><br />
                    @p.Mensaje
                </span>

                @if (usuarioId == Model.CreadorId && p.Estado == "Pendiente")
                {
                    <form asp-controller="Postulacion" asp-action="Aceptar" method="post">
                        <input type="hidden" name="id" value="@p.Id" />
                        <button type="submit" class="btn btn-success btn-sm">Aceptar</button>
                    </form>
                }
            </li>
        }
    </ul>

}

<hr />

@if (Model.Chat != null)
{
    <a asp-controller="Chat" asp-action="Details" asp-route-id="@Model.Chat.Id"
       class="btn btn-primary mt-3">Ir al Chat</a>
}
