@model IEnumerable<Favores_Back_mvc.Models.Chat>

@{
    ViewData["Title"] = "Mis Chats";
    var usuarioId = Context.Session.GetInt32("UsuarioId");
}

<h2>Mis Chats</h2>
<hr />

@if (!Model.Any())
{
    <p class="text-muted">No tenés chats iniciados.</p>
}
else
{
    <div class="list-group">

        @foreach (var chat in Model)
        {
            var ultimoMensaje = chat.Mensajes?
            .OrderByDescending(m => m.FechaHora)
            .FirstOrDefault();

            bool ultimoEsOtro = ultimoMensaje != null && ultimoMensaje.RemitenteId != usuarioId;

            <a asp-action="Details" asp-route-id="@chat.Id"
               class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">

                <div>
                    <h5 class="mb-1">@chat.Favor?.Titulo</h5>

                    @if (ultimoMensaje != null)
                    {
                        <small>
                            <strong>@ultimoMensaje.Remitente?.Email:</strong>
                            @ultimoMensaje.Texto.Substring(0, Math.Min(40, ultimoMensaje.Texto.Length))...
                        </small>
                    }
                    else
                    {
                        <small class="text-muted">Sin mensajes aún</small>
                    }
                </div>

                <div class="text-end">

                    @if (ultimoMensaje != null)
                    {
                        <small class="text-muted">
                            @ultimoMensaje.FechaHora.ToString("dd/MM HH:mm")
                        </small>
                    }

                    @if (ultimoEsOtro)
                    {
                        <span style="display:block; background:#0d6efd; color:white;
                                                 padding:3px 8px; border-radius:10px; margin-top:5px; font-size:12px;">
                            Nuevo
                        </span>
                    }
                </div>

            </a>
        }

    </div>
}
